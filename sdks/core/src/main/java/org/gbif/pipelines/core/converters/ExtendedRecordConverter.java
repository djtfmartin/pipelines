package org.gbif.pipelines.core.converters;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.function.Supplier;
import java.util.stream.Collectors;
import lombok.AccessLevel;
import lombok.NoArgsConstructor;
import org.gbif.dwc.record.Record;
import org.gbif.dwc.record.StarRecord;
import org.gbif.dwc.terms.DwcTerm;
import org.gbif.dwc.terms.Term;
import org.gbif.pipelines.core.interpreters.model.ExtendedRecord;

/** Converters from *.class to {@link ExtendedRecord} */
@NoArgsConstructor(access = AccessLevel.PRIVATE)
public class ExtendedRecordConverter {

  private static final String RECORD_ID_ERROR = "RECORD_ID_ERROR";

  // Function that removes all the empty elements of a record
  private static Map<String, String> convertToMap(Record record) {
    Map<String, String> map = new HashMap<>(record.terms().size() / 2);
    for (Term term : record.terms()) {
      String qn = term.qualifiedName();
      if (qn != null) {
        String value = record.value(term);
        if (value != null) {
          map.put(qn, value);
        }
      }
    }
    return map;
  }

  /** Converts {@link StarRecord} to {@link ExtendedRecord} */
  public static ExtendedRecord from(Record core,
                                    Map<Term, List<Record>> extensions,
                                    Supplier<ExtendedRecord> extendedRecordSupplier) {
    ExtendedRecord extendedRecord = extendedRecordSupplier.get();
    Optional.ofNullable(core.rowType()).ifPresent(x -> extendedRecord.setCoreRowType(x.qualifiedName()));
    extendedRecord.setCoreTerms(convertToMap(core));
    extendedRecord.setExtensions(
        extensions.entrySet().stream()
            .collect(
                Collectors.toMap(
                    entry -> entry.getKey().qualifiedName(),
                    entry ->
                        entry.getValue().stream()
                            .map(ExtendedRecordConverter::convertToMap)
                            .collect(Collectors.toList()))));

    extendedRecord.setId(getId(core, extendedRecord));
    return extendedRecord;
  }

  /** If id is null, use triplet as an id */
  private static String getId(Record core, ExtendedRecord partial) {
    if (core.id() != null) {
      return core.id();
    }

    String institutionCode = partial.getCoreTerms().get(DwcTerm.institutionCode.qualifiedName());
    String collectionCode = partial.getCoreTerms().get(DwcTerm.collectionCode.qualifiedName());
    String catalogNumber = partial.getCoreTerms().get(DwcTerm.catalogNumber.qualifiedName());

    if (institutionCode == null || collectionCode == null || catalogNumber == null) {
      return RECORD_ID_ERROR;
    }

    // id format following the convention of DwC (http://rs.tdwg.org/dwc/terms/#occurrenceID)
    return String.join(":", "urn:catalog", institutionCode, collectionCode, catalogNumber);
  }

  public static String getRecordIdError() {
    return RECORD_ID_ERROR;
  }
}

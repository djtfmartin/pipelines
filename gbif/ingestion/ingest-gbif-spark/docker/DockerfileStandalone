# Simple image that copy the already previous builds shaded jar into a specific location.
# This is used for SparkApplications to have a simple way to access the artifacts during their execution
FROM spark:3.5.1-scala2.12-java17-python3-ubuntu
ARG JAR_FILE=${JAVA_JAR_FILE}
USER root
RUN mkdir /jobs
COPY --chown=1000:1000 "./target/${JAR_FILE}" "/jobs/ingest-gbif-spark.jar"

RUN groupadd -r stackable && useradd -r -g stackable -m stackable
USER stackable:stackable

# Ensure Spark jars are accessible to the JVM
ENV SPARK_HOME=/opt/spark
ENV PATH="${SPARK_HOME}/bin:${PATH}"
ENV CLASSPATH="${SPARK_HOME}/jars/*:/jobs/ingest-gbif-spark.jar"

# Remove the conflicting or unwanted log4j binding from Spark jars
#RUN rm -f /opt/spark/jars/log4j-slf4j2-impl-2.20.0.jar

# Default runtime arguments
CMD ["MODE", "PATH_TO_CONFIG"]

# Use 'java' with Spark jars on classpath
ENTRYPOINT ["java", "--add-opens java.base/java.nio=ALL-UNNAMED", "--add-opens=java.base/java.lang.invoke=ALL-UNNAMED", "--add-opens=java.base/java.io=ALL-UNNAMED", "--add-exports=java.base/sun.nio.ch=ALL-UNNAMED", "--add-exports=java.base/sun.security.action=ALL-UNNAMED", "-cp", "/opt/spark/jars/*:/jobs/ingest-gbif-spark.jar", "org.gbif.pipelines.interpretation.standalone.Standalone"]
